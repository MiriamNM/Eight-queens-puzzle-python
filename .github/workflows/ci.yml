name: CI Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: macos-latest

    steps:
      # Instalar Docker y Docker Compose
      - name: Set up Docker and Docker Compose
        run: |
          brew install docker
          brew install docker-compose

      # Configurar Docker para que esté listo
      - name: Start Docker
        run: |
          open /Applications/Docker.app
          while ! docker info >/dev/null 2>&1; do
            echo "Esperando a que Docker esté listo..."
            sleep 5
          done

      # Checkout del repositorio
      - name: Checkout repository
        uses: actions/checkout@v2

      # Construir la imagen Docker
      - name: Build Docker image
        run: docker build -t eight-queens-puzzle .

      # Levantar contenedor con docker-compose
      - name: Run docker-compose
        run: docker-compose up -d

      # Ejecutar pruebas
      - name: Run tests
        run: docker-compose exec app pytest --maxfail=1 --disable-warnings -v

      # Apagar los contenedores después de las pruebas
      - name: Shutdown Docker containers
        if: always()
        run: docker-compose down
